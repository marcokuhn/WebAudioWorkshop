<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI-Triggered ADSR - Web Audio Workshop</title>
    <link rel="stylesheet" href="../resources/css/workshop-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        .piano-key {
            padding: 40px 10px 10px 10px;
            border: 2px solid #333;
            border-radius: 0 0 8px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.1s ease;
            user-select: none;
            position: relative;
        }
        
        .white-key {
            background: linear-gradient(to bottom, #fff 0%, #f0f0f0 100%);
            color: #333;
            min-width: 50px;
            height: 150px;
        }
        
        .black-key {
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            color: #fff;
            min-width: 35px;
            height: 100px;
            margin: 0 -17px;
            z-index: 2;
            border-color: #000;
        }
        
        .piano-key:hover {
            transform: translateY(2px);
        }
        
        .piano-key.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(4px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5) inset;
        }
        
        #virtualKeyboard {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 12px;
            overflow-x: auto;
        }
        
        #noteDisplay {
            font-size: 1.5em;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽ¹ MIDI-Triggered ADSR Envelope</h1>
            <p class="description">
                Connect a MIDI keyboard to play notes, or use the computer keyboard/virtual piano below!
                This example shows how to integrate external controllers with Web Audio.
            </p>
        </header>
        
        <main class="controls">
            <!-- Start Audio Context Button -->
            <div class="control-group">
                <h3>Audio Engine</h3>
                <button class="btn btn-success" id="startAudioBtn">ðŸŽµ Start Audio Engine</button>
                <div class="status status-warning" id="statusMessage">
                    Click "Start Audio Engine" to enable sound
                </div>
            </div>

            <!-- MIDI Device Selection -->
            <div class="control-group" id="midiSection" style="display: none;">
                <h3>MIDI Device</h3>
                
                <div class="control-row">
                    <span class="control-label">Select Device</span>
                    <div class="control-input">
                        <select id="midiDeviceSelect">
                            <option value="">Detecting devices...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- MIDI Status -->
            <div class="control-group" id="controlsSection" style="display: none;">
                <div class="status status-info" id="midiStatus">
                    Initializing MIDI...
                </div>

                <!-- Note Display -->
                <div id="noteDisplay">
                    No notes playing
                </div>
            </div>

            <!-- Virtual Keyboard -->
            <div class="control-group" id="keyboardSection" style="display: none;">
                <h3>Virtual Keyboard / Computer Keyboard</h3>
                <div class="status status-info">
                    <strong>Computer Keyboard Mapping:</strong><br>
                    Keys A-L play notes (with W, E, T, Y, U, O for sharps/flats)<br>
                    Or click/touch the virtual piano keys below
                </div>
                
                <div id="virtualKeyboard">
                    <!-- Piano keys will be generated by JavaScript -->
                </div>
            </div>

            <!-- ADSR Controls -->
            <div class="control-group" id="controlsSection2" style="display: none;">
                <h3>ADSR Envelope Settings</h3>
                
                <div class="control-row">
                    <span class="control-label">Attack Time</span>
                    <div class="control-input">
                        <input type="range" id="attackSlider" min="0.001" max="2" value="0.01" step="0.001">
                    </div>
                    <span class="value-display" id="attackValue">0.01s</span>
                </div>

                <div class="control-row">
                    <span class="control-label">Decay Time</span>
                    <div class="control-input">
                        <input type="range" id="decaySlider" min="0.01" max="2" value="0.2" step="0.01">
                    </div>
                    <span class="value-display" id="decayValue">0.20s</span>
                </div>

                <div class="control-row">
                    <span class="control-label">Sustain Level</span>
                    <div class="control-input">
                        <input type="range" id="sustainSlider" min="0" max="1" value="0.5" step="0.01">
                    </div>
                    <span class="value-display" id="sustainValue">50%</span>
                </div>

                <div class="control-row">
                    <span class="control-label">Release Time</span>
                    <div class="control-input">
                        <input type="range" id="releaseSlider" min="0.01" max="3" value="0.3" step="0.01">
                    </div>
                    <span class="value-display" id="releaseValue">0.30s</span>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="info-box">
                <h3>What's happening?</h3>
                <p>
                    This example uses the <strong>Web MIDI API</strong> to receive input from external MIDI devices
                    like keyboards, controllers, or drum pads. Each MIDI note triggers our ADSR envelope.
                </p>
                <p style="margin-top: 15px;">
                    <strong>MIDI Basics:</strong>
                </p>
                <ul style="margin-top: 10px; line-height: 1.8;">
                    <li><strong>Note On:</strong> Message sent when you press a key (includes note number and velocity)</li>
                    <li><strong>Note Off:</strong> Message sent when you release a key</li>
                    <li><strong>Note Number:</strong> 0-127 (60 = Middle C)</li>
                    <li><strong>Velocity:</strong> 0-127 (how hard the key was pressed)</li>
                </ul>
                <p style="margin-top: 15px;">
                    <strong>Polyphony:</strong> This synth can play multiple notes simultaneously using 
                    <code>Tone.PolySynth</code>. Try playing chords!
                </p>
                <p style="margin-top: 15px;">
                    <strong>No MIDI Device?</strong> Use the computer keyboard (keys A-L) or click the 
                    virtual piano keys above.
                </p>
            </div>

            <div class="code-hint">
                <h3>Key Concepts:</h3>
                <ul>
                    <li><code>navigator.requestMIDIAccess()</code> requests access to MIDI devices</li>
                    <li><code>input.onmidimessage</code> receives MIDI messages (note on/off, etc.)</li>
                    <li><code>Tone.PolySynth</code> plays multiple notes simultaneously (polyphonic)</li>
                    <li><code>Tone.Frequency(note, 'midi')</code> converts MIDI note numbers to frequencies</li>
                    <li><code>.triggerAttack()</code> and <code>.triggerRelease()</code> control note on/off</li>
                    <li>MIDI velocity (0-127) can control note volume dynamically</li>
                </ul>
            </div>

            <div class="code-hint">
                <h3>Basic Code Example:</h3>
                <pre><code class="language-javascript">// Create a polyphonic synthesizer
const synth = new Tone.PolySynth(Tone.Synth, {
    envelope: {
        attack: 0.01,
        decay: 0.2,
        sustain: 0.3,
        release: 0.8
    }
}).toDestination();

// Request MIDI access
navigator.requestMIDIAccess().then(midiAccess => {
    midiAccess.inputs.forEach(input => {
        input.onmidimessage = (message) => {
            const [command, note, velocity] = message.data;
            
            if (command === 144 && velocity > 0) {
                // Note On
                const freq = Tone.Frequency(note, 'midi').toFrequency();
                synth.triggerAttack(freq, undefined, velocity / 127);
            } else if (command === 128 || velocity === 0) {
                // Note Off
                const freq = Tone.Frequency(note, 'midi').toFrequency();
                synth.triggerRelease(freq);
            }
        };
    });
});</code></pre>
            </div>

            <div class="signal-flow">
                <div class="signal-node">MIDI Device / Keyboard</div>
                <div class="signal-arrow">â†’</div>
                <div class="signal-node">Note Trigger</div>
                <div class="signal-arrow">â†’</div>
                <div class="signal-node">PolySynth (Osc + ADSR)</div>
                <div class="signal-arrow">â†’</div>
                <div class="signal-node">Destination</div>
            </div>
        </footer>
    </div>

    <!-- Prism.js for Syntax Highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    
    <!-- Tone.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
    
    <!-- Our JavaScript -->
    <script src="script.js"></script>
    
    <script>
        // Show ADSR controls after audio starts
        document.getElementById('startAudioBtn').addEventListener('click', () => {
            setTimeout(() => {
                document.getElementById('controlsSection2').style.display = 'block';
            }, 100);
        });
    </script>
</body>
</html>